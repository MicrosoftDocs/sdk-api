---
UID: NF:objidl.IMarshal.GetMarshalSizeMax
title: IMarshal::GetMarshalSizeMax
author: windows-sdk-content
description: Retrieves the maximum size of the buffer that will be needed during marshaling.
old-location: com\imarshal_getmarshalsizemax.htm
old-project: com
ms.assetid: 25ec060a-ec46-4857-8d66-8f8bb58d6d31
ms.author: windowssdkdev
ms.date: 07/13/2018
ms.keywords: GetMarshalSizeMax, GetMarshalSizeMax method [COM], GetMarshalSizeMax method [COM],IMarshal interface, IMarshal interface [COM],GetMarshalSizeMax method, IMarshal.GetMarshalSizeMax, IMarshal::GetMarshalSizeMax, _com_imarshal_getmarshalsizemax, com.imarshal_getmarshalsizemax, objidl/IMarshal::GetMarshalSizeMax
ms.prod: windows
ms.technology: windows-sdk
ms.topic: method
req.header: objidl.h
req.include-header: 
req.target-type: Windows
req.target-min-winverclnt: Windows 2000 Professional [desktop apps | UWP apps]
req.target-min-winversvr: Windows 2000 Server [desktop apps | UWP apps]
req.kmdf-ver: 
req.umdf-ver: 
req.ddi-compliance: 
req.unicode-ansi: 
req.idl: ObjIdl.idl
req.max-support: 
req.namespace: 
req.assembly: 
req.type-library: 
tech.root: 
req.typenames: THDTYPE
topic_type:
 - APIRef
 - kbSyntax
api_type:
 - COM
api_location:
 - ObjIdl.h
api_name:
 - IMarshal.GetMarshalSizeMax
product: Windows
targetos: Windows
req.lib: 
req.dll: 
req.irql: 
req.product: ADAM
---

# IMarshal::GetMarshalSizeMax


## -description


Retrieves the maximum size of the buffer that will be needed during marshaling.


## -parameters




### -param riid [in]

A reference to the identifier of the interface to be marshaled.


### -param pv [in]

The interface pointer to be marshaled. This parameter can be <b>NULL</b>.


### -param dwDestContext [in]

The destination context where the specified interface is to be unmarshaled. Possible values come from the enumeration <a href="https://msdn.microsoft.com/d7d09ab2-96e7-48da-9292-0e4ca6cebe64">MSHCTX</a>. Unmarshaling can occur either in another apartment of the current process (MSHCTX_INPROC) or in another process on the same computer as the current process (MSHCTX_LOCAL).


### -param pvDestContext [in]

This parameter is reserved and must be <b>NULL</b>.


### -param mshlflags [in]

Indicates whether the data to be marshaled is to be transmitted back to the client processâ€”the typical caseâ€”or written to a global table, where it can be retrieved by multiple clients. Possible values come from the <a href="https://msdn.microsoft.com/42a482be-d4b8-4f2e-ae43-1d210cb44c7c">MSHLFLAGS</a> enumeration.


### -param pSize [out]

A pointer to a variable that receives the maximum size of the buffer.


## -returns



This method can return the standard return values E_FAIL and S_OK, as well as the following value.

<table>
<tr>
<th>Return code</th>
<th>Description</th>
</tr>
<tr>
<td width="40%">
<dl>
<dt><b>E_NOINTERFACE</b></dt>
</dl>
</td>
<td width="60%">
The specified interface is not supported.

</td>
</tr>
</table>
 




## -remarks



This method is called indirectly, in a call to <a href="https://msdn.microsoft.com/c04c736c-8efe-438b-9d21-8b6ad53d36e7">CoGetMarshalSizeMax</a>, by whatever code in the server process is responsible for marshaling a pointer to an interface on an object. This marshaling code is usually a stub generated by COM for one of several interfaces that can marshal a pointer to an interface implemented on an entirely different object. Examples include the <a href="https://msdn.microsoft.com/f624f833-2b69-43bc-92cd-c4ecbe6051c5">IClassFactory</a> and <a href="https://msdn.microsoft.com/fe306a36-da24-4b1e-ab42-359d37962d36">IOleItemContainer</a> interfaces. For purposes of discussion, the code responsible for marshaling a pointer is called the <i>marshaling stub</i>.

To create a proxy for an object, COM requires two pieces of information from the original object: the amount of data to be written to the marshaling stream and the proxy's CLSID.

The marshaling stub obtains these two pieces of information with successive calls to <a href="https://msdn.microsoft.com/c04c736c-8efe-438b-9d21-8b6ad53d36e7">CoGetMarshalSizeMax</a> and <a href="https://msdn.microsoft.com/04ca1217-eac1-43e2-b736-8d7522ce8592">CoMarshalInterface</a>.

<h3><a id="Notes_to_Callers"></a><a id="notes_to_callers"></a><a id="NOTES_TO_CALLERS"></a>Notes to Callers</h3>
The marshaling stub, through a call to <a href="https://msdn.microsoft.com/c04c736c-8efe-438b-9d21-8b6ad53d36e7">CoGetMarshalSizeMax</a>, calls the object's implementation of this method to preallocate the stream buffer that will be passed to <a href="https://msdn.microsoft.com/c48a7123-bd00-4ff3-8880-7fc4b99e4299">MarshalInterface</a>.

You do not explicitly call this method if you are implementing existing COM interfaces or using the Microsoft Interface Definition Language (MIDL) to define your own custom interfaces. In either case, the MIDL-generated stub automatically makes the call.

If you are not using MIDL to define your own interface (see <a href="https://msdn.microsoft.com/8a94bd7d-d101-411c-97de-9e9a46bf9591">Defining COM Interfaces</a>), your marshaling stub does not have to call <b>GetMarshalSizeMax</b>, although doing so is highly recommended. An object knows better than an interface stub what the maximum size of a marshaling data packet is likely to be. Therefore, unless you are providing an automatically growing stream that is so efficient that the overhead of expanding it is insignificant, you should call this method even when implementing your own interfaces.

The value returned by this method is guaranteed to be valid only as long as the internal state of the object being marshaled does not change. Therefore, the actual marshaling should be done immediately after this function returns, or the stub runs the risk that the object, because of some change in state, might require more memory to marshal than it originally indicated.

<h3><a id="Notes_to_Implementers"></a><a id="notes_to_implementers"></a><a id="NOTES_TO_IMPLEMENTERS"></a>Notes to Implementers</h3>
Your implementation of <a href="https://msdn.microsoft.com/c48a7123-bd00-4ff3-8880-7fc4b99e4299">MarshalInterface</a> will use the preallocated buffer to write marshaling data into the stream. If the buffer is too small, the marshaling operation will fail. Therefore, the value returned by this method must be a conservative estimate of the amount of data that will be needed to marshal the interface. Violation of this requirement should be treated as a catastrophic error.

In a subsequent call to <a href="https://msdn.microsoft.com/c48a7123-bd00-4ff3-8880-7fc4b99e4299">MarshalInterface</a>, your <a href="https://msdn.microsoft.com/e6f08949-f27d-4aba-adff-eaf9c356a928">IMarshal</a> implementation cannot rely on the caller actually having called <b>GetMarshalSizeMax</b> beforehand. It must still be wary of STG_E_MEDIUMFULL errors returned by the stream and be prepared to handle them gracefully.

To ensure that your implementation of <b>GetMarshalSizeMax</b> will continue to work properly as new destination contexts are supported in the future, delegate marshaling to the COM default implementation for all <i>dwDestContext</i> values that your implementation does not understand. To delegate marshaling to the COM default implementation, call the <a href="https://msdn.microsoft.com/0cb74adc-e192-4ae5-9267-02c79e301681">CoGetStandardMarshal</a> function.




## -see-also




<a href="https://msdn.microsoft.com/c04c736c-8efe-438b-9d21-8b6ad53d36e7">CoGetMarshalSizeMax</a>



<a href="https://msdn.microsoft.com/e6f08949-f27d-4aba-adff-eaf9c356a928">IMarshal</a>
 

 

